<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Слайд‑видео из картинок → MP4</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#0f172a;color:#e5e7eb;line-height:1.6}
    .container{max-width:900px;margin:0 auto;padding:20px}
    h1{font-size:24px;margin-top:0}
    .panel{background:#111827;padding:16px;border-radius:12px;margin-bottom:20px}
    input,textarea,select,button{margin-top:6px;width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#0a0f1c;color:#fff}
    button{cursor:pointer;background:linear-gradient(135deg,#22d3ee,#a78bfa);color:#000;font-weight:bold;border:0}
    canvas{background:#000;max-width:100%;border-radius:12px;margin-top:10px}
    .row{display:flex;gap:10px;margin-top:10px}
    .row button{flex:1}
    #slidesNav{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
    #slidesNav button{flex:none;width:32px;height:32px;border-radius:6px;padding:0}
    #status{margin-top:8px;font-size:14px;color:#94a3b8}
    #download{display:none;text-align:center;padding:10px 16px;border-radius:8px;background:#22d3ee;color:#000;font-weight:700}
  </style>
</head>
<body>
  <div class="container">
    <h1>Слайд‑видео из картинок → MP4</h1>

    <div class="panel">
      <label>Загрузите картинки:</label>
      <input id="files" type="file" accept="image/*" multiple />
      <label>Или добавьте URL картинки:</label>
      <input id="urlInput" type="text" placeholder="https://example.com/img.jpg">
      <button id="addUrl">Добавить URL</button>
      <label>Подписи (разделяйте пустой строкой):</label>
      <textarea id="captions"></textarea>
    </div>

    <div class="panel">
      <label>Разрешение:</label>
      <select id="resolution">
        <option value="1280x720">1280x720</option>
        <option value="1920x1080" selected>1920x1080</option>
      </select>
      <label>Длительность слайда (сек):</label>
      <input id="duration" type="number" value="3">
      <label>FPS:</label>
      <input id="fps" type="number" value="30">
      <div class="row">
        <button id="make">Собрать MP4</button>
        <a id="download" download="slideshow.mp4">Скачать MP4</a>
      </div>
      <div id="status">Готов к работе.</div>
    </div>

    <div class="panel">
      <h3>Превью слайда</h3>
      <canvas id="preview" width="640" height="360"></canvas>
      <div id="slidesNav"></div>
    </div>
  </div>

  <!-- ffmpeg.wasm: подключаем правильное ядро и экспортируем глобально -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.min.js"></script>
  <script>
    // Safari polyfill
    if (typeof window.TextEncoder === 'undefined') {
      window.TextEncoder = class { encode(s){ const a=new Uint8Array(s.length); for(let i=0;i<s.length;i++) a[i]=s.charCodeAt(i); return a; } };
    }

    // Достаём createFFmpeg из глобального объекта window.FFmpeg
    const { createFFmpeg } = window.FFmpeg;
    const ffmpeg = createFFmpeg({
      log: true,
      corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js'
    });

    const filesInput=document.getElementById('files');
    const urlInput=document.getElementById('urlInput');
    const addUrlBtn=document.getElementById('addUrl');
    const captionsInput=document.getElementById('captions');
    const resSel=document.getElementById('resolution');
    const durInput=document.getElementById('duration');
    const fpsInput=document.getElementById('fps');
    const makeBtn=document.getElementById('make');
    const dl=document.getElementById('download');
    const statusEl=document.getElementById('status');
    const canvas=document.getElementById('preview');
    const ctx=canvas.getContext('2d');
    const slidesNav=document.getElementById('slidesNav');

    let images=[];
    let slides=[];
    let currentSlide=0;

    function setStatus(t){statusEl.textContent=t}
    window.addEventListener('error', (e)=>{ setStatus('Ошибка: '+ (e.message||e.type)); });

    function splitCaptions(raw){return raw.replace(/\r\n/g,'\n').split(/\n\s*\n/).map(s=>s.trim()).filter(Boolean)}

    async function loadImage(item){
      return new Promise((res,rej)=>{
        const img=new Image();
        if(item.srcType==='url') img.crossOrigin='anonymous';
        img.onload=()=>res(img);
        img.onerror=()=>rej(new Error('Ошибка загрузки'));
        if(item.srcType==='file'){
          const fr=new FileReader(); fr.onload=()=>img.src=fr.result; fr.readAsDataURL(item.file);
        }else img.src=item.url;
      });
    }

    function drawSlide(slide){
      const [w,h]=resSel.value.split('x').map(Number);
      canvas.width=w; canvas.height=h;
      ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h);
      if(slide && slide.img){
        const fit=Math.min(w/slide.img.width,h/slide.img.height);
        const iw=slide.img.width*fit, ih=slide.img.height*fit;
        const x=(w-iw)/2, y=(h-ih)/2;
        ctx.drawImage(slide.img,x,y,iw,ih);
        if(slide.caption){ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(0,h-60,w,60);ctx.fillStyle='#fff';ctx.font='24px sans-serif';ctx.fillText(slide.caption,20,h-25)}
      }else if(slide && slide.caption){
        ctx.fillStyle='#fff';ctx.font='bold 40px sans-serif';ctx.textAlign='center';ctx.fillText(slide.caption,w/2,h/2)
      } else {
        ctx.fillStyle='#94a3b8';ctx.textAlign='center';ctx.font='20px sans-serif';ctx.fillText('Добавьте картинки или подписи',w/2,h/2);
      }
    }

    function renderNav(){
      slidesNav.innerHTML='';
      slides.forEach((s,i)=>{
        const b=document.createElement('button');
        b.textContent=i+1; if(i===currentSlide) b.style.background='#22d3ee';
        b.onclick=()=>{currentSlide=i; drawSlide(slides[i]); renderNav()};
        slidesNav.appendChild(b);
      });
    }

    async function rebuildSlides(){
      const caps=splitCaptions(captionsInput.value);
      const count=Math.max(images.length,caps.length);
      slides=[];
      for(let i=0;i<count;i++){
        let img=null;
        if(i<images.length){try{img=await loadImage(images[i])}catch{}}
        slides.push({img,caption:caps[i]||''});
      }
      currentSlide=0;
      drawSlide(slides[0]||null);
      renderNav();
      setStatus(`Слайдов: ${slides.length}`);
    }

    filesInput.addEventListener('change',()=>{for(const f of filesInput.files) images.push({srcType:'file',file:f}); rebuildSlides()});
    addUrlBtn.addEventListener('click',()=>{if(urlInput.value){images.push({srcType:'url',url:urlInput.value});urlInput.value='';rebuildSlides()}});
    captionsInput.addEventListener('input',rebuildSlides);
    resSel.addEventListener('change',()=>{if(slides.length) drawSlide(slides[currentSlide])});

    function dataURLToBytes(dataURL){ const bin=atob(dataURL.split(',')[1]); const bytes=new Uint8Array(bin.length); for(let j=0;j<bin.length;j++) bytes[j]=bin.charCodeAt(j); return bytes; }

    async function makeVideo(){
      try{
        if(!slides.length){alert('Нет слайдов');return}
        makeBtn.disabled=true; dl.style.display='none'; setStatus('Загрузка кодека…');
        if(!ffmpeg.isLoaded()) await ffmpeg.load();

        try{ffmpeg.FS('unlink','list.txt')}catch{}
        try{ffmpeg.FS('unlink','output.mp4')}catch{}

        const fps=parseInt(fpsInput.value)||30; const dur=Math.max(1,parseInt(durInput.value)||3);
        for(let i=0;i<slides.length;i++){
          drawSlide(slides[i]);
          const bytes=dataURLToBytes(canvas.toDataURL('image/png'));
          ffmpeg.FS('writeFile',`slide${i}.png`,bytes);
        }
        let list='ffconcat version 1.0\n';
        for(let i=0;i<slides.length;i++){list+=`file slide${i}.png\n`; list+=`duration ${dur}\n`}
        list+=`file slide${slides.length-1}.png\n`;
        ffmpeg.FS('writeFile','list.txt',new TextEncoder().encode(list));

        setStatus('Кодирование…');
        await ffmpeg.run('-y','-f','concat','-safe','0','-i','list.txt','-r',String(fps),'-c:v','libx264','-pix_fmt','yuv420p','-movflags','+faststart','output.mp4');

        const data=ffmpeg.FS('readFile','output.mp4');
        const url=URL.createObjectURL(new Blob([data.buffer],{type:'video/mp4'}));
        dl.href=url; dl.style.display='block'; setStatus('Видео собрано.');
      } catch(err){
        console.error(err); setStatus('Ошибка: '+(err.message||err));
      } finally {
        makeBtn.disabled=false;
      }
    }

    makeBtn.addEventListener('click',makeVideo);

    // первый рендер
    drawSlide(null);
  </script>
</body>
</html>
